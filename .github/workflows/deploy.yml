name: Deploy to Railway

# Trigger the workflow on push to main or manual dispatch
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # Lint and test job
  test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint --if-present
        continue-on-error: true
      
      - name: Check for security vulnerabilities
        run: npm audit --audit-level=moderate
        continue-on-error: true
  
  # Deploy to Railway
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link ${{ secrets.RAILWAY_PROJECT_ID }} || echo "Project already linked"
          railway up --detach
      
      - name: Set environment variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway variables set DISCORD_TOKEN="${{ secrets.DISCORD_TOKEN }}"
          railway variables set DISCORD_CLIENT_ID="${{ secrets.DISCORD_CLIENT_ID }}"
          railway variables set SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          railway variables set SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"
          railway variables set NODE_ENV="production"
      
      - name: Deployment summary
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üì¶ Repository: ${{ github.repository }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"
  
  # Optional: Notify on deployment status
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment succeeded"
          else
            echo "‚ùå Deployment failed"
          fi

# Required GitHub Secrets:
# - RAILWAY_TOKEN: Railway API token
# - RAILWAY_PROJECT_ID: Railway project ID (optional, for linking)
# - DISCORD_TOKEN: Discord bot token
# - DISCORD_CLIENT_ID: Discord application client ID
# - SUPABASE_URL: Supabase project URL
# - SUPABASE_ANON_KEY: Supabase anon key

# Setup Instructions:
# 1. Go to repository Settings ‚Üí Secrets and variables ‚Üí Actions
# 2. Add all required secrets listed above
# 3. Get Railway token from: https://railway.app/account/tokens
# 4. Get Railway project ID from: railway status (after linking project)
# 5. Push to main branch to trigger deployment
